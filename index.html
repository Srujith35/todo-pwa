<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Tasks</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --text: #0f172a;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --success: #10b981;
      --danger: #ef4444;
      --shadow: 0 6px 18px rgba(12, 18, 29, 0.06);
      --modal-overlay: rgba(0, 0, 0, 0.5);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      padding-bottom: 88px;
    }

    .container { max-width: 1000px; margin: 0 auto; padding: 16px; }

    /* Header */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 12px; }
    .brand h1 { font-size: 22px; font-weight: 800; color: var(--accent); }
    .brand span { font-size: 12px; color: var(--text-muted); display: block; }

    /* Calendar */
    .calendar-section { background: var(--card); border-radius: 12px; padding: 12px 0; margin-bottom: 18px; box-shadow: var(--shadow); position: relative; }
    .month-label { font-weight: 700; font-size: 16px; text-align: center; min-width: 120px; margin-bottom: 8px; }

    .nav-btn { 
      background: var(--bg); border: 1px solid var(--border); width: 36px; height: 36px; 
      border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; 
      font-size: 16px; color: var(--text);
    }
    .nav-btn:active{ transform: scale(0.97); }

    .calendar-strip {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 4px 12px 12px 12px;
      /* IMPORTANT: Default is AUTO (Instant). We add 'smooth' class later via JS */
      scroll-behavior: auto; 
      white-space: nowrap;
      align-items: center;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    
    .calendar-strip.enable-smooth {
      scroll-behavior: smooth;
    }

    .calendar-strip::-webkit-scrollbar { display: none; }

    .cal-day {
      flex: 0 0 auto;
      width: 72px;
      min-width: 72px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 6px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.15s, background 0.15s, box-shadow 0.15s;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .cal-day:active { transform: scale(0.95); }
    
    .cal-day.selected {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(59,130,246,0.25);
    }

    .cal-day.today { border-color: var(--accent); border-width: 2px; }
    .cal-day .daynum { font-size: 18px; font-weight: 700; margin-top: 6px; }
    .cal-day .wk { font-size: 11px; text-transform: uppercase; opacity: 0.8; }

    .dots { display: flex; justify-content: center; gap: 4px; margin-top: 6px; height: 6px; }
    .dot { width: 5px; height: 5px; border-radius: 50%; }
    .dot.has-incomplete { background: var(--danger); }
    .cal-day.selected .dot.has-incomplete { background: white; }

    /* Controls */
    .controls { display: flex; gap: 10px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
    .controls::-webkit-scrollbar { display: none; }
    
    .pill-btn { 
      padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border); 
      background: var(--card); font-size: 13px; white-space: nowrap; cursor: pointer; 
      transition: all 0.2s;
    }
    .pill-btn.active { background: var(--text); color: white; border-color: var(--text); }

    /* Tasks */
    .task-list { display: flex; flex-direction: column; gap: 12px; min-height: 200px; }
    .task-card { 
      background: var(--card); border-radius: 12px; padding: 14px; display: flex; align-items: flex-start; gap: 12px; 
      box-shadow: var(--shadow); border: 1px solid transparent; transition: 0.2s;
    }
    .task-card.completed { opacity: 0.6; background: var(--bg); box-shadow: none; border-color: var(--border); }
    .task-card.completed .task-title { text-decoration: line-through; color: var(--text-muted); }
    
    .checkbox { 
      width: 22px; height: 22px; border-radius: 6px; border: 2px solid var(--border); 
      display: flex; align-items: center; justify-content: center; cursor: pointer; margin-top: 2px; flex-shrink: 0;
      transition: 0.2s;
    }
    .checkbox.checked { background: var(--success); border-color: var(--success); color: white; }
    
    .task-content { flex: 1; }
    .task-title { font-weight: 600; font-size: 15px; margin-bottom: 4px; word-break: break-word; }
    .task-meta { font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .priority-tag { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
    .p-high { background: #fee2e2; color: #ef4444; }
    .p-medium { background: #fef3c7; color: #d97706; }
    .p-low { background: #dcfce7; color: #16a34a; }

    .delete-btn { border: none; background: none; font-size: 16px; cursor: pointer; opacity: 0.4; padding: 4px; transition: opacity 0.2s; }
    .delete-btn:hover { opacity: 1; color: var(--danger); }

    /* FAB & Modal */
    .fab {
      position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px;
      background: var(--accent); color: white; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 32px; box-shadow: 0 6px 22px rgba(59, 130, 246, 0.3);
      border: none; cursor: pointer; z-index: 90; transition: transform 0.2s;
    }
    .fab:active { transform: scale(0.90); }

    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--modal-overlay); z-index: 100;
      display: none; justify-content: center; align-items: flex-end;
      opacity: 0; transition: opacity 0.2s;
    }
    .modal-overlay.open { display: flex; opacity: 1; }

    .modal-card {
      background: var(--card); width: 100%; max-width: 520px;
      border-radius: 20px 20px 0 0; padding: 22px;
      transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .modal-overlay.open .modal-card { transform: translateY(0); }

    @media(min-width: 600px) {
      .modal-overlay { align-items: center; }
      .modal-card { border-radius: 20px; margin: 20px; transform: translateY(20px); }
      .modal-overlay.open .modal-card { transform: translateY(0); }
    }

    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
    .modal-title { font-size: 18px; font-weight: 700; }
    .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted); padding: 0 8px; }

    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-muted); text-transform: uppercase; }
    .full-input, .full-select { 
      width: 100%; padding: 12px; border: 1px solid var(--border); 
      border-radius: 10px; font-size: 16px; background: var(--bg); 
      outline: none; transition: border-color 0.2s;
    }
    .full-input:focus, .full-select:focus { border-color: var(--accent); }
    
    .btn-submit {
      width: 100%; background: var(--accent); color: white; padding: 14px;
      border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;
    }

    .loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 3px solid rgba(0,0,0,0.1); border-top: 3px solid var(--accent); border-radius: 50%; width: 32px; height: 32px; animation: spin 0.8s linear infinite; display: none; z-index: 200; }
    @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

/* UPDATE TOAST POPUP */
    .update-toast {
      position: fixed; 
      bottom: 30px; 
      left: 50%; 
      transform: translateX(-50%) translateY(100px); /* Hidden down */
      background: var(--text); 
      color: white; 
      padding: 12px 20px; 
      border-radius: 50px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      display: flex; 
      align-items: center; 
      gap: 15px; 
      z-index: 1000;
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      width: max-content;
      max-width: 90%;
    }

    .update-toast.show {
      transform: translateX(-50%) translateY(0); /* Slide up */
    }

    .update-text {
      font-size: 14px;
      font-weight: 500;
    }

    .update-btn {
      background: var(--accent); 
      color: white; 
      border: none; 
      padding: 8px 16px; 
      border-radius: 20px; 
      font-size: 12px; 
      font-weight: 700; 
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .update-btn:active {
      transform: scale(0.95);
    }



 
  </style>
</head>
<body>

  <div id="loader" class="loader"></div>

  <button id="fabBtn" class="fab">+</button>

  <div class="container">
    <div class="header">
      <div class="brand">
        <h1>Tasks</h1>
        <span>Supabase Sync</span>
      </div>
      <div style="display:flex; align-items:center; gap:8px;">
        <button class="nav-btn" id="prevWeek">‚Üê</button>
        <button class="nav-btn" id="nextWeek">‚Üí</button>
        <button id="refreshBtn" class="nav-btn" style="width:auto; padding: 0 12px; font-size:13px; font-weight:600;">Sync</button>
      </div>
    </div>

    <div class="month-label" id="monthLabel">...</div>

    <div class="calendar-section">
      <div id="calendarStrip" class="calendar-strip"></div>
    </div>

    <div class="controls">
      <button class="pill-btn active" data-filter="all">All</button>
      <button class="pill-btn" data-filter="today">Today</button>
      <button class="pill-btn" data-filter="active">Active</button>
      <button class="pill-btn" data-filter="completed">Done</button>
    </div>

    <div id="taskList" class="task-list"></div>
  </div>

  <div id="addModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">New Task</div>
        <button class="close-modal" id="closeModal">√ó</button>
      </div>
      <div class="form-group">
        <label>Task Name</label>
        <input type="text" id="taskTitleInput" class="full-input" placeholder="e.g., Buy groceries">
      </div>
      <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div>
          <label>Due Date</label>
          <input type="date" id="taskDateInput" class="full-input">
        </div>
        <div>
          <label>Priority</label>
          <select id="taskPriorityInput" class="full-select">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>
      </div>
      <button id="saveTaskBtn" class="btn-submit">Save Task</button>
    </div>
  </div>

  <div id="updateToast" class="update-toast">
    <span class="update-text">New version available</span>
    <button id="updateAppBtn" class="update-btn">Update</button>
  </div>

  <script>
    // CONFIG
    const SUPABASE_URL = 'https://ehzdeplfeifwwccilbnu.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_Z_rxKGrCQLDkPUQnc3mVeA_2WH8ASE0';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const $ = id => document.getElementById(id);

    // STATE
    let tasks = [];
    let selectedDate = null;
    let currentFilter = 'all';
    let days = [];
    let startOffset = -30;  
    let endOffset = 30;
    
    // FLAGS
    let isAppReady = false; // Locks scroll logic until init done
    let isExtending = false;
    let isSnapping = false;

    // --- INITIAL SETUP & CALENDAR RENDER ---
    
    function generateInitialDays() {
      days = [];
      for (let i = startOffset; i <= endOffset; i++) {
        const d = new Date();
        d.setDate(d.getDate() + i);
        days.push({
          offset: i,
          iso: d.toISOString().split('T')[0],
          wk: d.toLocaleString('en-US', { weekday: 'short' }),
          num: d.getDate()
        });
      }
    }

    function createDayEl(d, todayISO) {
      const el = document.createElement('div');
      el.className = `cal-day ${d.iso === todayISO ? 'today' : ''} ${selectedDate === d.iso ? 'selected' : ''}`;
      el.dataset.iso = d.iso;
      
      const hasTasks = tasks.some(t => t.due === d.iso && !t.completed);
      el.innerHTML = `
        <div class="wk">${d.wk}</div>
        <div class="daynum">${d.num}</div>
        ${ hasTasks ? '<div class="dots"><div class="dot has-incomplete"></div></div>' : '' }
      `;
      
      el.onclick = () => selectDate(d.iso);
      return el;
    }

    function renderCalendar() {
      const strip = $('calendarStrip');
      const todayISO = new Date().toISOString().split('T')[0];
      strip.innerHTML = '';
      
      const frag = document.createDocumentFragment();
      days.forEach(d => frag.appendChild(createDayEl(d, todayISO)));
      strip.appendChild(frag);
    }

    function selectDate(iso) {
      selectedDate = iso;
      // Update visual selection
      document.querySelectorAll('.cal-day').forEach(el => {
        if (el.dataset.iso === iso) el.classList.add('selected');
        else el.classList.remove('selected');
      });
      renderTasks();
      
      // Only scroll if app is ready (user interaction)
      if (isAppReady) {
        scrollToIso(iso, true); 
      }
    }

    // --- SCROLL LOGIC ---

    function scrollToIso(iso, smooth = false) {
      const strip = $('calendarStrip');
      const target = strip.querySelector(`[data-iso="${iso}"]`);
      if (!target) return;

      // If app isn't ready, force instant scroll via JS calculation to avoid browser quirks
      if (!isAppReady || !smooth) {
        const stripWidth = strip.clientWidth;
        const targetLeft = target.offsetLeft;
        const targetWidth = target.offsetWidth;
        strip.scrollLeft = targetLeft - (stripWidth / 2) + (targetWidth / 2);
      } else {
        target.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }
    }

    function updateMonthLabel() {
      const strip = $('calendarStrip');
      const center = strip.scrollLeft + (strip.clientWidth / 2);
      
      // Find element closest to center pixel
      let closest = null;
      let minDiff = Infinity;
      
      for (const child of strip.children) {
        const childCenter = child.offsetLeft + (child.offsetWidth / 2);
        const diff = Math.abs(childCenter - center);
        if (diff < minDiff) {
          minDiff = diff;
          closest = child;
        }
      }

      if (closest && closest.dataset.iso) {
        const d = new Date(closest.dataset.iso);
        const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        $('monthLabel').textContent = `${monthNames[d.getMonth()]} ${d.getFullYear()}`;
      }
    }

    // Debounced snap logic
    let snapTimeout;
    function handleScroll() {
      // 1. Infinite Scroll Check
      const strip = $('calendarStrip');
      if (isAppReady && !isExtending) {
        if (strip.scrollLeft < 100) extendLeft();
        else if (strip.scrollWidth - strip.clientWidth - strip.scrollLeft < 100) extendRight();
      }

      // 2. Update Month Label immediately
      updateMonthLabel();

      // 3. Snap Logic (Only if app is ready)
      if (isAppReady) {
        clearTimeout(snapTimeout);
        snapTimeout = setTimeout(() => {
          if (!isSnapping && !isExtending) {
            isSnapping = true;
            snapToCenter();
            setTimeout(() => isSnapping = false, 400);
          }
        }, 150); // Wait for scroll to stop
      }
    }

    function snapToCenter() {
      const strip = $('calendarStrip');
      const center = strip.scrollLeft + (strip.clientWidth / 2);
      let closest = null;
      let minDiff = Infinity;
      for (const child of strip.children) {
        const childCenter = child.offsetLeft + (child.offsetWidth / 2);
        const diff = Math.abs(childCenter - center);
        if (diff < minDiff) { minDiff = diff; closest = child; }
      }
      if (closest) {
        closest.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }
    }

    // --- INFINITE EXTENSION ---
    function extendRight() {
      isExtending = true;
      const strip = $('calendarStrip');
      const todayISO = new Date().toISOString().split('T')[0];
      
      for(let i=1; i<=15; i++) {
        endOffset++;
        const d = new Date(); d.setDate(d.getDate() + endOffset);
        const dayObj = { offset: endOffset, iso: d.toISOString().split('T')[0], wk: d.toLocaleString('en-US',{weekday:'short'}), num: d.getDate() };
        days.push(dayObj);
        strip.appendChild(createDayEl(dayObj, todayISO));
      }
      isExtending = false;
    }

    function extendLeft() {
      isExtending = true;
      const strip = $('calendarStrip');
      const prevScrollW = strip.scrollWidth;
      const todayISO = new Date().toISOString().split('T')[0];
      
      // Temporarily disable smooth behavior if it was enabled
      strip.classList.remove('enable-smooth');
      
      const newNodes = [];
      for(let i=1; i<=15; i++) {
        startOffset--;
        const d = new Date(); d.setDate(d.getDate() + startOffset);
        const dayObj = { offset: startOffset, iso: d.toISOString().split('T')[0], wk: d.toLocaleString('en-US',{weekday:'short'}), num: d.getDate() };
        days.unshift(dayObj);
        newNodes.unshift(createDayEl(dayObj, todayISO));
      }
      
      newNodes.forEach(n => strip.insertBefore(n, strip.firstChild));
      
      // Adjust scroll to maintain position
      const addedW = strip.scrollWidth - prevScrollW;
      strip.scrollLeft += addedW;
      
      requestAnimationFrame(() => {
        if(isAppReady) strip.classList.add('enable-smooth');
        isExtending = false;
      });
    }

    // --- TASKS & DATA ---

    async function fetchTasks() {
      try {
        const { data, error } = await supabase.from('tasks').select('*').order('created_at', { ascending: false });
        if (data) {
          tasks = data.map(t => ({ ...t, due: t.due ? t.due.split('T')[0] : null }));
          renderCalendar(); // refresh dots
          renderTasks();
          // Restore selection visual after re-render
          if(selectedDate) selectDate(selectedDate);
        }
      } catch(e) { console.error(e); }
    }

    function renderTasks() {
      const list = $('taskList');
      list.innerHTML = '';
      let filtered = tasks;

      if (selectedDate) filtered = filtered.filter(t => t.due === selectedDate);
      if (currentFilter === 'today') filtered = filtered.filter(t => t.due === new Date().toISOString().split('T')[0]);
      else if (currentFilter === 'active') filtered = filtered.filter(t => !t.completed);
      else if (currentFilter === 'completed') filtered = filtered.filter(t => t.completed);

      if (filtered.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:40px; opacity:0.5">No tasks here</div>`;
        return;
      }

      filtered.forEach(t => {
        const el = document.createElement('div');
        el.className = `task-card ${t.completed ? 'completed' : ''}`;
        el.innerHTML = `
          <div class="checkbox ${t.completed ? 'checked' : ''}">${t.completed ? '‚úì' : ''}</div>
          <div class="task-content">
            <div class="task-title">${t.title.replace(/</g,'&lt;')}</div>
            <div class="task-meta"><span class="priority-tag p-${t.priority}">${t.priority}</span>${t.due ? ` üìÖ ${t.due}`:''}</div>
          </div>
          <button class="delete-btn">üóëÔ∏è</button>
        `;
        el.querySelector('.checkbox').onclick = () => toggleTask(t.id, t.completed);
        el.querySelector('.delete-btn').onclick = () => deleteTask(t.id);
        list.appendChild(el);
      });
    }

    async function addTask() {
      const title = $('taskTitleInput').value.trim();
      if (!title) return;
      $('saveTaskBtn').textContent = 'Saving...';
      
      const newTask = { 
        title, 
        due: $('taskDateInput').value || null, 
        priority: $('taskPriorityInput').value, 
        completed: false 
      };

      const { data, error } = await supabase.from('tasks').insert([newTask]).select();
      if (!error && data) {
        // Local update
        const t = { ...data[0], due: data[0].due ? data[0].due.split('T')[0] : null };
        tasks.unshift(t);
        renderCalendar();
        renderTasks();
        // Select the date of the new task to show it
        if (t.due) {
            selectDate(t.due);
            scrollToIso(t.due, true);
        }
        closeModal();
        $('taskTitleInput').value = '';
      }
      $('saveTaskBtn').textContent = 'Save Task';
    }

    async function toggleTask(id, status) {
      const t = tasks.find(x => x.id === id);
      if (t) t.completed = !status;
      renderTasks(); renderCalendar();
      await supabase.from('tasks').update({ completed: !status }).eq('id', id);
    }

    async function deleteTask(id) {
      if (!confirm('Delete?')) return;
      tasks = tasks.filter(t => t.id !== id);
      renderTasks(); renderCalendar();
      await supabase.from('tasks').delete().eq('id', id);
    }

    // --- UI HANDLERS ---
    function openModal() { 
      $('taskDateInput').value = selectedDate || new Date().toISOString().split('T')[0];
      $('addModal').classList.add('open'); 
    }
    function closeModal() { $('addModal').classList.remove('open'); }
    
    function jump(days) {
      const current = new Date(selectedDate || new Date());
      current.setDate(current.getDate() + days);
      const iso = current.toISOString().split('T')[0];
      selectDate(iso);
    }

    // --- BOOTSTRAP ---
    async function init() {
      $('loader').style.display = 'block';
      
      generateInitialDays();
      renderCalendar();
      
      const today = new Date().toISOString().split('T')[0];
      selectedDate = today;

      // INITIAL SCROLL: Perform instant scroll BEFORE listeners are active
      // We do this inside a requestAnimationFrame to ensure DOM is painted
      requestAnimationFrame(() => {
         scrollToIso(today, false); // false = Instant
         updateMonthLabel();
      });

      await fetchTasks();
      
      // EVENT LISTENERS
      $('prevWeek').onclick = () => jump(-7);
      $('nextWeek').onclick = () => jump(7);
      $('fabBtn').onclick = openModal;
      $('closeModal').onclick = closeModal;
      $('saveTaskBtn').onclick = addTask;
      $('refreshBtn').onclick = fetchTasks;
      
      document.querySelectorAll('.pill-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('.pill-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          renderTasks();
        };
      });

      // Add scroll listener
      $('calendarStrip').addEventListener('scroll', handleScroll);

      // UNLOCK APP: Enable smooth scrolling only after initial setup is settled
      setTimeout(() => {
        isAppReady = true;
        $('calendarStrip').classList.add('enable-smooth');
        $('loader').style.display = 'none';
      }, 300); // 300ms buffer for initial layout to stabilize
    }

    init();
// --- SERVICE WORKER / AUTO UPDATE LOGIC ---
    
    if ('serviceWorker' in navigator) {
      let newWorker;

      // Register the service worker
      navigator.serviceWorker.register('/service-worker.js').then(reg => {
        
        // Check for updates on load
        reg.addEventListener('updatefound', () => {
          newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            // If there is a new worker and it's installed
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // Show the popup
              document.getElementById('updateToast').classList.add('show');
            }
          });
        });
      });

      // Handle the "Update" button click
      document.getElementById('updateAppBtn').addEventListener('click', () => {
        // Find the worker that is waiting and tell it to activate
        if (newWorker) {
          newWorker.postMessage({ type: 'SKIP_WAITING' });
        }
      });

      // Reload page when the new service worker takes control
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!refreshing) {
          window.location.reload();
          refreshing = true;
        }
      });
    }
  </script>
</body>
</html>
