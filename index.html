<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Modern To-Do List (Supabase)</title>
  
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#3b82f6" />
  <link rel="apple-touch-icon" href="icon-192.png"> <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --text: #0f172a;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --success: #10b981;z
      --warning: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --modal-overlay: rgba(0, 0, 0, 0.5);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      padding-bottom: 80px; /* Space for FAB */
    }

    .container { max-width: 1000px; margin: 0 auto; padding: 16px; }

    /* Header */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .brand h1 { font-size: 24px; font-weight: 800; color: var(--accent); }
    .brand span { font-size: 12px; color: var(--text-muted); display: block; }

    /* Calendar Section */
    .calendar-section { background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 20px; box-shadow: var(--shadow); }
    .calendar-controls { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .month-label { font-weight: 700; font-size: 16px; }
    
    .nav-btn { 
      background: var(--bg); border: 1px solid var(--border); width: 32px; height: 32px; 
      border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; 
    }

    .calendar-strip { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; scroll-behavior: smooth; }
    .calendar-strip::-webkit-scrollbar { height: 0px; display: none; } /* Hide scrollbar */
    
    .cal-day { 
      min-width: 60px; flex: 1; background: var(--bg); border: 1px solid var(--border); 
      border-radius: 10px; padding: 10px 4px; text-align: center; cursor: pointer; transition: 0.2s; 
    }
    .cal-day.selected { background: var(--accent); border-color: var(--accent); color: white; transform: scale(1.05); }
    .cal-day.today { border-color: var(--accent); border-width: 2px; }
    .cal-day .daynum { font-size: 20px; font-weight: 700; }
    .cal-day .wk { font-size: 10px; text-transform: uppercase; opacity: 0.8; }
    
    /* Task Dot Indicators */
    .dots { display: flex; justify-content: center; gap: 3px; margin-top: 4px; height: 4px; }
    .dot { width: 4px; height: 4px; border-radius: 50%; }
    .dot.has-incomplete { background: var(--danger); }
    .selected .dot.has-incomplete { background: white; }

    /* Controls & Filters */
    .controls { display: flex; gap: 10px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 5px; }
    .pill-btn { 
      padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); 
      background: var(--card); font-size: 13px; white-space: nowrap; cursor: pointer; 
    }
    .pill-btn.active { background: var(--text); color: white; border-color: var(--text); }

    /* Task List */
    .task-list { display: flex; flex-direction: column; gap: 12px; }
    .task-card { 
      background: var(--card); border-radius: 12px; padding: 16px; display: flex; align-items: flex-start; gap: 12px; 
      box-shadow: var(--shadow); border: 1px solid transparent; transition: 0.2s;
    }
    .task-card.completed { opacity: 0.6; background: var(--bg); }
    .task-card.completed .task-title { text-decoration: line-through; color: var(--text-muted); }
    
    .checkbox { 
      width: 22px; height: 22px; border-radius: 6px; border: 2px solid var(--border); 
      display: flex; align-items: center; justify-content: center; cursor: pointer; margin-top: 2px; flex-shrink: 0;
    }
    .checkbox.checked { background: var(--success); border-color: var(--success); color: white; }
    
    .task-content { flex: 1; }
    .task-title { font-weight: 600; font-size: 15px; margin-bottom: 4px; }
    .task-meta { font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 8px; }
    .priority-tag { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
    .p-high { background: #fee2e2; color: #ef4444; }
    .p-medium { background: #fef3c7; color: #d97706; }
    .p-low { background: #dcfce7; color: #16a34a; }

    .delete-btn { border: none; background: none; font-size: 16px; cursor: pointer; opacity: 0.5; padding: 4px; }

    /* FLOATING ACTION BUTTON (FAB) */
    .fab {
      position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px;
      background: var(--accent); color: white; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 32px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      border: none; cursor: pointer; z-index: 90; transition: transform 0.2s;
    }
    .fab:active { transform: scale(0.95); }

    /* MODAL (ADD TASK) */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--modal-overlay); z-index: 100;
      display: none; justify-content: center; align-items: flex-end; /* Bottom sheet on mobile */
    }
    .modal-overlay.open { display: flex; }

    .modal-card {
      background: var(--card); width: 100%; max-width: 500px;
      border-radius: 20px 20px 0 0; padding: 24px;
      animation: slideUp 0.3s ease-out;
    }
    @media(min-width: 600px) {
      .modal-overlay { align-items: center; }
      .modal-card { border-radius: 20px; margin: 20px; }
    }

    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-title { font-size: 18px; font-weight: 700; }
    .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted); }

    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-muted); }
    .full-input, .full-select { 
      width: 100%; padding: 12px; border: 1px solid var(--border); 
      border-radius: 8px; font-size: 16px; background: var(--bg); 
    }
    .btn-submit {
      width: 100%; background: var(--accent); color: white; padding: 14px;
      border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;
    }

    /* Loading */
    .loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: none; z-index: 200; }
    @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loader" class="loader"></div>

  <button id="fabBtn" class="fab">+</button>

  <div class="container">
    <div class="header">
      <div class="brand">
        <h1>Tasks</h1>
        <span>Supabase Sync</span>
      </div>
      <button id="refreshBtn" class="nav-btn" style="width: auto; padding: 0 12px; font-size: 12px;">Sync</button>
    </div>

    <div class="calendar-section">
      <div class="calendar-controls">
        <button class="nav-btn" id="prevWeek">‚Üê</button>
        <span class="month-label" id="monthLabel">Month</span>
        <button class="nav-btn" id="nextWeek">‚Üí</button>
      </div>
      <div id="calendarStrip" class="calendar-strip"></div>
    </div>

    <div class="controls">
      <button class="pill-btn active" data-filter="all">All</button>
      <button class="pill-btn" data-filter="today">Today</button>
      <button class="pill-btn" data-filter="active">Active</button>
      <button class="pill-btn" data-filter="completed">Done</button>
    </div>

    <div id="taskList" class="task-list">
      </div>
  </div>

  <div id="addModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">New Task</div>
        <button class="close-modal" id="closeModal">√ó</button>
      </div>
      
      <div class="form-group">
        <label>What needs to be done?</label>
        <input type="text" id="taskTitleInput" class="full-input" placeholder="e.g., Buy groceries" autofocus>
      </div>

      <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div>
          <label>Due Date</label>
          <input type="date" id="taskDateInput" class="full-input">
        </div>
        <div>
          <label>Priority</label>
          <select id="taskPriorityInput" class="full-select">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>
      </div>

      <button id="saveTaskBtn" class="btn-submit">Save Task</button>
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = 'https://ehzdeplfeifwwccilbnu.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_Z_rxKGrCQLDkPUQnc3mVeA_2WH8ASE0'; // Use your Key here

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const $ = id => document.getElementById(id);

    // State
    let tasks = [];
    let calendarStart = new Date(); 
    calendarStart.setDate(calendarStart.getDate() - 2); // Start slightly in past
    let selectedDate = null; // YYYY-MM-DD
    let currentFilter = 'all';

    // --- INIT ---
    async function init() {
        setLoading(true);
        renderCalendar();
        setupEvents();
        await fetchTasks();
        setLoading(false);
    }

    function setupEvents() {
        // Navigation
        $('prevWeek').addEventListener('click', () => shiftCalendar(-7));
        $('nextWeek').addEventListener('click', () => shiftCalendar(7));
        
        // Modal Logic
        $('fabBtn').addEventListener('click', openModal);
        $('closeModal').addEventListener('click', closeModal);
        $('addModal').addEventListener('click', (e) => {
            if(e.target === $('addModal')) closeModal();
        });

        // Task Logic
        $('saveTaskBtn').addEventListener('click', addTask);
        $('refreshBtn').addEventListener('click', async () => {
            setLoading(true);
            await fetchTasks();
            setLoading(false);
        });

        // Filter Buttons
        document.querySelectorAll('.pill-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.pill-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderTasks();
            });
        });
    }

    // --- CALENDAR LOGIC ---
    function shiftCalendar(days) {
        calendarStart.setDate(calendarStart.getDate() + days);
        renderCalendar();
    }

    function renderCalendar() {
        const strip = $('calendarStrip');
        strip.innerHTML = '';
        
        const daysToShow = 7; // Show 1 week at a time on strip (cleaner on mobile)
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        
        // Update Month Label based on the middle of the view
        const midDate = new Date(calendarStart);
        midDate.setDate(midDate.getDate() + 3);
        $('monthLabel').textContent = `${monthNames[midDate.getMonth()]} ${midDate.getFullYear()}`;

        for (let i = 0; i < daysToShow; i++) {
            const d = new Date(calendarStart);
            d.setDate(calendarStart.getDate() + i);
            const iso = d.toISOString().split('T')[0];
            const isToday = iso === new Date().toISOString().split('T')[0];

            const el = document.createElement('div');
            el.className = `cal-day ${isToday ? 'today' : ''} ${selectedDate === iso ? 'selected' : ''}`;
            
            // Check for dots
            const dayTasks = tasks.filter(t => t.due === iso);
            const hasIncomplete = dayTasks.some(t => !t.completed);
            
            el.innerHTML = `
                <div class="wk">${d.toLocaleString('en-US', { weekday: 'short' })}</div>
                <div class="daynum">${d.getDate()}</div>
                ${hasIncomplete ? '<div class="dots"><div class="dot has-incomplete"></div></div>' : ''}
            `;

            el.addEventListener('click', () => {
                selectedDate = selectedDate === iso ? null : iso; // Toggle
                renderCalendar(); // Re-render to update styling
                renderTasks();
            });

            strip.appendChild(el);
        }
    }

    // --- TASK LOGIC ---

    async function fetchTasks() {
        const { data, error } = await supabase
            .from('tasks')
            .select('*')
            .order('created_at', { ascending: false });
        
        if(!error && data) {
            tasks = data;
            renderCalendar(); // Update dots
            renderTasks();
        }
    }

    function renderTasks() {
        const list = $('taskList');
        list.innerHTML = '';

        let filtered = tasks;

        // Filter by Date Selection
        if (selectedDate) {
            filtered = filtered.filter(t => t.due === selectedDate);
        }

        // Filter by Pills
        if (currentFilter === 'today') {
            const today = new Date().toISOString().split('T')[0];
            filtered = filtered.filter(t => t.due === today);
        } else if (currentFilter === 'active') {
            filtered = filtered.filter(t => !t.completed);
        } else if (currentFilter === 'completed') {
            filtered = filtered.filter(t => t.completed);
        }

        if (filtered.length === 0) {
            list.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:40px;">No tasks found</div>`;
            return;
        }

        filtered.forEach(t => {
            const el = document.createElement('div');
            el.className = `task-card ${t.completed ? 'completed' : ''}`;
            el.innerHTML = `
                <div class="checkbox ${t.completed ? 'checked' : ''}">
                    ${t.completed ? '‚úì' : ''}
                </div>
                <div class="task-content">
                    <div class="task-title">${t.title}</div>
                    <div class="task-meta">
                        <span class="priority-tag p-${t.priority}">${t.priority}</span>
                        ${t.due ? `<span>üìÖ ${t.due}</span>` : ''}
                    </div>
                </div>
                <button class="delete-btn">üóëÔ∏è</button>
            `;

            // Events
            el.querySelector('.checkbox').addEventListener('click', () => toggleTask(t.id, t.completed));
            el.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteTask(t.id);
            });

            list.appendChild(el);
        });
    }

    async function addTask() {
        const title = $('taskTitleInput').value.trim();
        if (!title) return;
        
        const btn = $('saveTaskBtn');
        const originalText = btn.textContent;
        btn.textContent = 'Saving...';
        btn.disabled = true;

        // 1. Generate ID locally (Fixes the "null value in column id" error)
        const newId = Date.now().toString();

        const newTask = {
            id: newId,
            title: title,
            due: $('taskDateInput').value || null,
            priority: $('taskPriorityInput').value,
            completed: false
        };

        // 2. Optimistic Update (Show it on screen immediately)
        tasks.unshift(newTask);
        renderCalendar();
        renderTasks();
        closeModal();
        
        // Clear input
        $('taskTitleInput').value = ''; 

        // 3. Send to Supabase in the background
        const { error } = await supabase.from('tasks').insert([newTask]);

        if (error) {
            console.error('Supabase Error:', error);
            alert('Error adding task: ' + error.message);
            
            // If it failed, remove the task from the screen
            tasks = tasks.filter(t => t.id !== newId);
            renderCalendar();
            renderTasks();
        }

        btn.textContent = originalText;
        btn.disabled = false;
    }

    async function toggleTask(id, oldStatus) {
        // Optimistic Update
        const t = tasks.find(x => x.id === id);
        if(t) t.completed = !oldStatus;
        renderTasks();
        renderCalendar();

        await supabase.from('tasks').update({ completed: !oldStatus }).eq('id', id);
    }

    async function deleteTask(id) {
        if(!confirm("Delete this task?")) return;
        
        // Optimistic
        tasks = tasks.filter(t => t.id !== id);
        renderTasks();
        renderCalendar();

        await supabase.from('tasks').delete().eq('id', id);
    }

    // --- MODAL HELPERS ---
    function openModal() {
        // Auto-set date if calendar date selected
        if(selectedDate) $('taskDateInput').value = selectedDate;
        else $('taskDateInput').value = new Date().toISOString().split('T')[0];
        
        $('addModal').classList.add('open');
        $('taskTitleInput').focus();
    }

    function closeModal() {
        $('addModal').classList.remove('open');
    }

    function setLoading(state) {
        $('loader').style.display = state ? 'block' : 'none';
    }

    init();
    // ... your existing code ...

    init();

    // --- ADD PWA REGISTRATION HERE ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((reg) => console.log('Service Worker registered!', reg))
          .catch((err) => console.log('Service Worker failed:', err));
      });
    }
  </script>
</body>
</html>
